name: SonarQube PR Analysis

permissions:
  pull-requests: write

on:
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  sonarqube:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Run tests and generate coverage
        run: mvn -B clean verify jacoco:report

      - name: SonarQube Scan (multi-module)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: mvn verify sonar:sonar -Dsonar.login=$SONAR_TOKEN -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.projectKey=org.web:codeFm

      - name: SonarQube Quality Gate Check
        uses: sonarsource/sonarqube-quality-gate-action@v1
        with:
          scanMetadataReportFile: ./target/sonar/report-task.txt
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Get Quality Gate Details
        if: always()
        env:
          SONAR_USER: ${{ secrets.SONAR_USER }}
          SONAR_PASSWORD: ${{ secrets.SONAR_PASSWORD }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          # Get metrics y status
          METRICS_JSON=$(curl -s -u "${SONAR_USER}:${SONAR_PASSWORD}" "${SONAR_HOST_URL}/api/measures/component?component=org.web:codeFm&metricKeys=new_bugs,new_vulnerabilities,new_security_hotspots,new_code_smells,new_coverage,new_duplicated_lines_density")
          STATUS_JSON=$(curl -s -u "${SONAR_USER}:${SONAR_PASSWORD}" "${SONAR_HOST_URL}/api/qualitygates/project_status?projectKey=org.web:codeFm")

          # Funci√≥n para convertir rating num√©rico a c√≠rculo de color
          rating_to_circle() {
            case $1 in
              1.0) echo "üü¢" ;; # Verde - A
              2.0) echo "üü®" ;; # Amarillo - B
              3.0) echo "üüß" ;; # Naranja - C
              4.0) echo "üî¥" ;; # Rojo - D
              5.0) echo "‚≠ï" ;; # Rojo oscuro - E
              *) echo "$1" ;;
            esac
          }

          {
            echo "## üîç Quality Gate Report"
            echo

            # Secci√≥n 1: M√©tricas
            echo "### üìä Metrics"
            echo "$METRICS_JSON" | jq -r '.component.measures[] |
            (if .metric == "new_coverage" or .metric == "new_duplicated_lines_density" then
              .period.value + "%"
            else
              .period.value
            end) as $value |
            "- [\(
            if .metric == "new_bugs" then "Bugs"
            elif .metric == "new_vulnerabilities" then "Vulnerabilities"
            elif .metric == "new_security_hotspots" then "Security Hotspots"
            elif .metric == "new_code_smells" then "Code Smells"
            elif .metric == "new_coverage" then "Coverage"
            elif .metric == "new_duplicated_lines_density" then "Duplicated Lines"
            else .metric
            end)](\($ENV.SONAR_HOST_URL)/component_measures?id=org.web:codeFm&metric=\(.metric)&view=list) ‚Üí \($value)"'
            echo

            # Secci√≥n 2: Quality Gate Status
            echo "### üéØ Quality Gate Status"
            STATUS=$(echo "$STATUS_JSON" | jq -r '.projectStatus.status')
            if [ "$STATUS" = "OK" ]; then
              echo "#### ‚úÖ Overall Status: PASSED"
            else
              echo "#### ‚ùå Overall Status: FAILED"
            fi
            echo

            # Estados individuales con c√≠rculos de color
            echo "$STATUS_JSON" | jq -r '.projectStatus.conditions[] |
            (if .metricKey | endswith("_rating") then
              "Rating " + .actualValue
            elif .metricKey | test("new_coverage|new_duplicated_lines_density") then
              .actualValue + "% / " + .errorThreshold + "%"
            else
              .actualValue
            end) as $values |
            "- \(if .status=="OK" then "‚úÖ" else "‚ùå" end) [\(
            if .metricKey == "new_coverage" then "Coverage"
            elif .metricKey == "new_duplicated_lines_density" then "Duplicated Lines"
            elif .metricKey == "new_reliability_rating" then "Reliability"
            elif .metricKey == "new_security_rating" then "Security"
            elif .metricKey == "new_maintainability_rating" then "Maintainability"
            else .metricKey
            end)] ‚Üí \($values)"' | while read line; do
              if [[ $line == *"Rating "* ]]; then
                rating=$(echo $line | grep -o "Rating [0-9.]*" | cut -d' ' -f2)
                circle=$(rating_to_circle $rating)
                echo "${line/Rating $rating/$circle}"
              else
                echo "$line"
              fi
            done
            echo

            echo "üîé <a href=\"${SONAR_HOST_URL}/dashboard?id=org.web:codeFm&selected=new_code\" target=\"_blank\">View analysis in SonarQube</a>"
          } > qualitygate-details.txt
        shell: bash

      - name: Comment Quality Gate details on PR
        if: always()
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: qualitygate-details.txt
          edit-mode: replace